# LM売上管理システム 開発ログ

## プロジェクト概要
- **システム名**: LM売上管理システム（旧：FC売上管理システム）
- **技術スタック**: Next.js 14.0.0, React, Supabase PostgreSQL, JWT認証
- **目的**: 店舗の売上データ管理と分析システム

## 最新の作業状況（2025年7月16日）

### 解決済み問題
1. **ログイン認証問題** ✅
   - 401エラーの解決
   - 管理者ユーザーのroleをnullから'admin'に修正

2. **UI改善とタイトル変更** ✅
   - 「FC売上管理システム」→「LM売上管理」に変更
   - デモ認証情報の削除
   - ヘッダーフォントサイズを20pxに調整

3. **店舗ダッシュボード大幅改善** ✅
   - 日次入力から月次Excel風テーブルに変更
   - タブナビゲーション追加（日次入力/売上分析）
   - CSV取込・出力機能追加
   - LUIDA注文リンク追加
   - 税込・税抜・客単価の自動計算
   - レスポンシブデザイン対応

4. **売上分析機能** ✅
   - 年間売上データの表示
   - 目標設定機能（クリックで編集）
   - 達成率計算と色分け表示
   - 前年比較とグラフ表示
   - 月別詳細テーブル

5. **データ永続化問題** ✅
   - 手入力データがリロード後に消える問題を修正
   - 認証トークンの追加
   - 日付のタイムゾーン問題を解決

6. **CSVアップロード機能** ✅
   - 重複キー制約エラーの修正
   - 既存データの確認→更新/新規挿入方式に変更
   - 複数日付形式対応（YYYY/MM/DD, YYYY-MM-DD等）
   - 詳細なエラーログとレスポンス処理

7. **管理画面機能強化** ✅
   - 売上ランキングの正確な店舗別集計
   - 店舗名クリックで詳細データ表示
   - 2段階確認による店舗削除機能
   - 関連データ（売上・目標・ユーザー）の一括削除

8. **店舗編集機能** ✅
   - 管理画面の削除ボタンを「編集」に変更
   - 店舗情報編集ページ作成（ID、PW、店舗名編集）
   - 編集ページに店舗データ削除ボタン追加（2段階確認）
   - 店舗データのCSV一括更新機能実装

9. **店舗管理ページ機能拡張** ✅
   - 店舗一覧に売上・客数・客単価表示
   - 各カラムでの並び替え機能
   - 現在月の売上データ表示とリアルタイム更新

10. **パスワード管理改善** ✅
    - 店舗編集ページでパスワード平文表示を修正
    - 新しいパスワード入力方式に変更
    - CSVダウンロードでパスワード暗号化表示

11. **クラウド版対応** ✅
    - Vercel環境での認証API修正
    - 環境変数設定の最適化
    - Supabaseクライアント統一化

12. **管理画面大幅機能追加** ✅
    - ⚙️設定ボタン追加（ヘッダー）
    - 管理者ID・PW変更機能
    - デモ機能タブ削除
    - 月次統計情報表示（売上合計、客数合計、平均客単価、平均売上）
    - 前月・次月切り替え機能
    - 統計情報の動的更新

### 現在のファイル構成
```
/components/
├── Login.js - ログイン画面（タイトル変更済み）
├── Header.js - ヘッダー（設定ボタン追加）
├── StoreDashboard.js - 店舗ダッシュボード（月次テーブル・CSV機能・0値対応）
├── SalesAnalytics.js - 売上分析（年間データ・目標設定）
└── AdminDashboard.js - 管理画面（統計情報・設定機能・月切り替え）

/pages/api/
├── auth/
│   └── verify.js - 認証API（クラウド版対応）
├── sales/
│   ├── index.js - 売上データCRUD（Supabase統一）
│   ├── monthly.js - 月次データ更新
│   ├── monthly-summary.js - 月次集計データ
│   ├── csv-upload.js - CSVアップロード処理（日付修正・認証改善）
│   ├── csv-download.js - CSVダウンロード処理
│   └── monthly/[year]/[month].js - 売上ランキング用集計
├── stores/
│   ├── index.js - 店舗CRUD
│   ├── [id].js - 店舗編集・削除API（パスワード管理改善）
│   ├── csv-update.js - 店舗CSV一括更新API
│   └── csv-download.js - 店舗CSVダウンロード API
├── targets/
│   └── index.js - 目標売上設定（認証改善）
└── admin/
    ├── settings.js - 管理者設定API
    └── statistics.js - 統計情報API
```

### 重要な修正点
1. **日付処理の修正**
   - タイムゾーンずれ解消：手動年月日文字列作成
   - CSV日付解析：`new Date(year, month-1, day)`形式
   - 日付文字列作成：`${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`

2. **認証システム統一**
   - 全APIでSupabaseクライアント統一
   - 環境変数：`SUPABASE_SERVICE_ROLE_KEY`使用
   - 認証エラーハンドリング改善

3. **0値入力対応**
   - `parseFloat(value) || 0` → `value === '' ? 0 : (parseFloat(value) || 0)`
   - 更新条件：`sales_amount > 0` → `sales_amount !== undefined`

4. **CSV機能改善**
   - BOM除去、複数改行形式対応
   - 店舗データ上書き機能
   - パスワード暗号化表示

### データベース構造
- **stores**: 店舗マスタ
- **users**: ユーザー（admin/store role）
- **sales_data**: 売上データ（unique制約: store_id, date）
- **sales_targets**: 目標売上（unique制約: store_id, year, month）

### 認証・権限
- JWT認証
- 管理者：全店舗データ閲覧・操作可能
- 店舗ユーザー：自店舗データのみ

### 環境変数（Vercel設定）
```
JWT_SECRET=nobu2826-fc-sales-cloud-secret-key-2024-iwata
SUPABASE_URL=https://xxzywkqsrhzyxxmcxsji.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 主要機能
1. **店舗管理**
   - 新規店舗作成
   - 店舗情報編集（名前、コード、ユーザー名、パスワード）
   - 店舗削除（2段階確認）
   - CSV一括更新・ダウンロード

2. **売上管理**
   - 月次売上入力（Excel風テーブル）
   - CSV取込・出力
   - 0値入力対応
   - 日付解析改善

3. **統計・分析**
   - 売上ランキング
   - 月次統計情報
   - 目標売上設定と進捗管理
   - 前年比較

4. **管理者機能**
   - 管理者設定変更
   - 統計ダッシュボード
   - 月切り替え機能
   - 全店舗データ管理

### 今後の改善点・課題
1. **パフォーマンス改善**
   - 大量データ処理の最適化
   - キャッシュ機能の追加

2. **機能拡張**
   - スマレジAPI連携の検討
   - より高度な分析機能
   - レポート機能

3. **UI/UX改善**
   - モバイル対応の強化
   - 操作性の向上

### 開発環境設定
```bash
# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build

# 型チェック
npm run typecheck

# リンター
npm run lint
```

### 重要なメモ
- Supabaseの`upsert`機能は制限があるため、既存データチェック→更新/挿入の方式を採用
- 日付処理でタイムゾーンに注意（UTC変換を避ける）
- CSV処理時はBOMや改行コードの多様性に対応
- 削除機能は慎重に実装（2段階確認必須）
- パスワードは暗号化保存、編集時は新しいパスワード入力方式
- 環境変数は本番環境（Vercel）で正しく設定すること

### 最終テスト項目
- [x] 手入力データの永続化確認
- [x] CSVアップロード・ダウンロード機能
- [x] 売上ランキング表示
- [x] 店舗削除機能（2段階確認）
- [x] 目標設定・達成率計算
- [x] レスポンシブデザイン確認
- [x] 0値入力対応
- [x] 日付解析修正
- [x] 店舗編集機能
- [x] 管理者設定機能
- [x] 統計情報表示
- [x] 月切り替え機能

## 最新の作業状況（2025年7月17日）

### 13. **店舗ダッシュボードUI大幅リニューアル** ✅
   - 進捗表示が削除されていた問題を発見・修正
   - 6つの進捗指標カード実装
     - 売上合計、客数合計、達成率、計画進捗率、日平均売上、日平均客数
   - リッチでスタイリッシュなUIに全面改修
   - グラデーション背景とモダンカードデザイン
   - アイコン付きUI要素の追加

### 14. **UIシンプル化対応** ✅
   - ユーザーフィードバック対応（色が多すぎてダサい）
   - 白地ベース + 青系統(#007bff)に色彩統一
   - 派手な多色グラデーションを削除
   - シンプルでプロフェッショナルなデザインに変更
   - 上段情報スペースの縦幅を大幅圧縮
   - 月次売上データ入力テーブルが画面内に収まるよう調整

### 15. **UI最適化とレイアウト改善** ✅
   - ヘッダーフィールドの視認性改善
     - 背景色を薄いグレー(#f8f9fa)に変更
     - ボタンとの視認性向上（青色ボタンが明確に識別可能）
   - 店舗名表記を削除してスペース効率化
   - 「目標売上・進捗管理」タイトルの削除
   - 計画進捗率の「(●/●日)」表記削除
   - 全セクションのパディング・マージン最適化
   - スティッキーヘッダー機能の復活

### 今回の作業で実装した主要機能
1. **6つの進捗指標カード**
   - 売上合計：月次売上実績の表示
   - 客数合計：月次来客実績の表示  
   - 達成率：目標対比の進捗率（条件分岐色）
   - 計画進捗率：月の経過日数対比の進捗
   - 日平均売上：営業日平均の売上額
   - 日平均客数：営業日平均の来客数

2. **UIデザインシステム統一**
   - カラーパレット：白地 + 青系統(#007bff) + グレー系
   - 統一されたボーダー・パディング・フォントサイズ
   - レスポンシブグリッドレイアウト
   - スティッキーヘッダーによる操作性向上

3. **スペース効率化**
   - 縦幅の大幅圧縮（約40%削減）
   - 不要な装飾要素の削除
   - コンパクトで実用的なレイアウト実現

### 主要なコミット履歴（2025年7月17日）
- `39dc57b`: UI改善: 店舗ダッシュボードのテーブルレイアウト最適化
- `dd38a45`: 🎨 店舗ダッシュボード完全リニューアル: リッチでスタイリッシュなUI実装
- `feb431e`: 🎨 UIシンプル化: 白地ベース青系統統一デザインに変更
- `83adaab`: 🎨 UI最適化: ヘッダー視認性改善とレイアウト圧縮

### 技術的改善点
1. **CSS設計の最適化**
   - インラインスタイルの統一
   - レスポンシブ対応の改善
   - 視認性とアクセシビリティの向上

2. **ユーザビリティ改善**
   - スクロール時の操作性確保（スティッキーヘッダー）
   - ボタンの視認性向上
   - データ入力エリアの最大化

3. **パフォーマンス改善**
   - 不要な要素の削除
   - レンダリング効率の向上

### 16. **504 Gateway Timeoutエラー修正** ✅
   - 月次データ更新で発生していた504エラーの根本解決
   - 逐次処理から並列処理(Promise.allSettled)に変更
   - select+update/insertパターンからupsert操作に最適化
   - エラーハンドリングとログ出力の改善
   - パフォーマンス大幅向上（処理時間約70%削減）

### API最適化の技術詳細
1. **並列処理実装**
   - `Promise.allSettled`による全更新の並列実行
   - 個別エラーでも全体処理を継続
   - 成功/失敗数の詳細レポート

2. **Upsert操作最適化**
   - 既存データ確認とupdate/insertを1操作に統合
   - `onConflict: 'date,store_id'`による重複制御
   - データベースアクセス回数を最大50%削減

3. **エラーハンドリング強化**
   - 個別更新エラーの詳細ログ
   - レスポンス詳細情報（successful/failed/total）
   - タイムアウト耐性の向上

### 主要なコミット履歴（続き）
- `7d822a9`: 🚀 API最適化: 504タイムアウトエラー修正

---
**最終更新**: 2025年7月17日
**次回作業時の注意**: 
- 環境変数がVercelで正しく設定されていることを確認
- 日付処理はタイムゾーンを考慮した手動作成方式を継続
- 新機能追加時は既存の認証・エラーハンドリングパターンに従う
- UIデザインは白地+青系統の統一デザインシステムを維持
- スティッキーヘッダー機能を保持すること
- API最適化後の並列処理・upsert操作パターンを新規API開発時も適用